#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# TODO: try to merge this with other architecture's do-qemu scripts if possible

# host operating system
HOST_OS=$(uname -s)

# host architecture
HOST_OS_ARCH=$(uname -m)
case $HOST_OS_ARCH in
  aarch64*|arm64)
    # flatten either aarch64 or arm64 to arm64 to keep it simple
    HOST_OS_ARCH="arm64"
    ;;
  *) ;;
esac
readonly HOST_OS
readonly HOST_OS_ARCH

# echo HOST_OS = "$HOST_OS"
# echo HOST_OS_ARCH = "$HOST_OS_ARCH"

function HELP {
    echo "help:"
    echo "-p <project>      : specify the project to build (default qemu-virt-arm32-test, qemu-virt-arm64-test or lm3s6965evb-test)"
    echo "-6                : 64bit arm (default is 32bit)"
    echo "-3                : cortex-m3 based platform (most other options ignored)"
    echo "-P <page size>    : set the page size (default: 4K, valid: 4k/4096, 16k/16384, 64k/65536)"
    echo "-v                : boot kernel at EL2"
    echo "-k                : use KVM or HVF acceleration if present (only on 64bit)"
    echo "-m <memory in MB> : memory size (default: 512 MB)"
    echo "-s <number of cpus> : number of CPUs (default: 1)"
    echo "-X                : print QEMU command and exit (dry run)"
    echo
    echo "-c                : cmpctmalloc instead of dlmalloc"
    echo "-M                : miniheap instead of dlmalloc"
    echo
    echo "-d <disk image>   : add a virtio disk device (may be used multiple times)"
    echo "-n                : add a virtio network device (user mode networking)"
    echo "-t                : add a virtio tap network device (requires tap interface setup)"
    echo "-g                : add a virtio display (GPU, keyboard, mouse)"
    echo "-f <shared dir>   : add a virtio 9p device with a host shared directory"
    echo "-G <gic version>  : override gic version (2, 3 or host). Default nothing, which lets qemu pick."
    echo
    echo "-h                : show this help"
    echo "all arguments after -- are passed to qemu directly"
    exit 1
}

DO_NET=0
DO_NET_TAP=0
DISK_IMAGES=()
DO_64BIT=0
DO_VIRT=0
DO_CORTEX_M3=0
DO_KVM=0
DO_DISPLAY=0
DO_CMPCTMALLOC=0
DO_MINIHEAP=0
DO_V9P=0
DO_V9P_DIR=""
PAGE_SIZE=4096
SMP=1
MEMSIZE=512
SUDO=""
PROJECT=""
DO_DRYRUN=0
GIC_VERSION=""

while getopts cd:gG:hkm:Mnt36vp:P:s:f:X FLAG; do
    case $FLAG in
        c) DO_CMPCTMALLOC=1;;
        d)
            DISK_IMAGES+=("$OPTARG")
            ;;
        g) DO_DISPLAY=1;;
        G) GIC_VERSION=$OPTARG;;
        f) DO_V9P=1; DO_V9P_DIR=$OPTARG;;
        k) DO_KVM=1;;
        M) DO_MINIHEAP=1;;
        n) DO_NET=1;;
        t) DO_NET_TAP=1;;
        3) DO_CORTEX_M3=1;;
        6) DO_64BIT=1;;
        v) DO_VIRT=1;;
        m) MEMSIZE=$OPTARG;;
        s) SMP=$OPTARG;;
        p) PROJECT=$OPTARG;;
        P) PAGE_SIZE=$OPTARG;;
        X) DO_DRYRUN=1;;
        h) HELP;;
        \?)
            echo unrecognized option
            HELP
    esac
done

shift $((OPTIND-1))

# validate option combinations
if (( DO_CORTEX_M3 )); then
    # Cortex-M3 platform is very limited and doesn't support most features
    INVALID_OPTS=()
    if (( DO_64BIT )); then INVALID_OPTS+=("-6 (64-bit)"); fi
    if (( DO_KVM )); then INVALID_OPTS+=("-k (KVM/HVF)"); fi
    if (( DO_VIRT )); then INVALID_OPTS+=("-v (EL2)"); fi
    if (( ${#DISK_IMAGES[@]} > 0 )); then INVALID_OPTS+=("-d (disk)"); fi
    if (( DO_NET || DO_NET_TAP )); then INVALID_OPTS+=("-n/-t (network)"); fi
    if (( DO_DISPLAY )); then INVALID_OPTS+=("-g (display)"); fi
    if (( DO_V9P )); then INVALID_OPTS+=("-f (9p)"); fi
    if [[ "$PAGE_SIZE" != "4096" ]]; then INVALID_OPTS+=("-P (page size)"); fi

    if (( ${#INVALID_OPTS[@]} > 0 )); then
        echo "Warning: -3 (Cortex-M3) does not support: ${INVALID_OPTS[*]}"
        echo "These options will be ignored."
    fi
fi

if (( DO_64BIT && DO_VIRT && DO_KVM )); then
    echo "Error: Cannot use both -v (EL2) and -k (KVM/HVF) together"
    exit 1
fi

if (( !DO_64BIT && DO_KVM )); then
    echo "Error: -k (KVM/HVF) is only supported with -6 (64-bit)"
    exit 1
fi

if (( DO_NET && DO_NET_TAP )); then
    echo "Error: Cannot use both -n (user network) and -t (tap network) together"
    exit 1
fi

# accept some aliases to page size
if [ "$PAGE_SIZE" == "4k" ]; then
    PAGE_SIZE=4096
elif [ "$PAGE_SIZE" == "16k" ]; then
    PAGE_SIZE=16384
elif [ "$PAGE_SIZE" == "64k" ]; then
    PAGE_SIZE=65536
fi

# if GIC_VERSION is specified, set the appropriate string
GIC_STRING=""
if [ -n "$GIC_VERSION" ]; then
    GIC_STRING=",gic_version=$GIC_VERSION"
fi

# pick the appropriate qemu and project
if (( DO_64BIT )); then
    QEMU="qemu-system-aarch64"
    CPU="cortex-a76" # default to something recent that modern qemu supports
    MACHINE="virt"
    MACHINE+=$GIC_STRING

    # if using KVM/HVF, switch to a host cpu and enable acceleration
    if (( DO_KVM )); then
        CPU="host"
        if [ -n "$GIC_STRING" ]; then
            echo "error: cannot override GIC version when using KVM/HVF acceleration"
            exit 1
        fi
        if [ "$HOST_OS" == "Darwin" ]; then
            # TODO: can the gic version be set to host on macOS?
            MACHINE+=",gic_version=2,accel=hvf"
        elif [ "$HOST_OS" == "Linux" ]; then
            MACHINE+=",gic_version=host,accel=kvm"
        fi
    elif (( DO_VIRT )); then
        MACHINE+=",virtualization=on"
    fi

    if [ "$PAGE_SIZE" == 65536 ]; then
        _PROJECT="qemu-virt-arm64-64k-test"
    elif [ "$PAGE_SIZE" == 16384 ]; then
        _PROJECT="qemu-virt-arm64-16k-test"
    else
        _PROJECT="qemu-virt-arm64-test"
    fi
elif (( DO_CORTEX_M3 )); then
    QEMU="qemu-system-arm"
    CPU="cortex-m3"
    MACHINE="lm3s6965evb"
    _PROJECT="lm3s6965evb-test"
else
    QEMU="qemu-system-arm"
    CPU="cortex-a15"
    MACHINE="virt"
    MACHINE+=$GIC_STRING
    MACHINE+=",highmem=off" # disable the high PCI ECAM, since we dont support LPAE to map it
    _PROJECT="qemu-virt-arm32-test"

    if (( DO_KVM )); then
        echo "error: KVM acceleration is only supported for 64bit ARM"
        exit 1
    fi
fi

# allow overriding the project from the environment
if [ -z "$PROJECT" ]; then
    PROJECT=$_PROJECT
fi

# construct a list of args based on previous variables using arrays
ARGS=()
ARGS+=("-cpu" "$CPU")
ARGS+=("-m" "$MEMSIZE")
ARGS+=("-smp" "$SMP")
ARGS+=("-machine" "$MACHINE")
ARGS+=("-kernel" "build-${PROJECT}/lk.elf")

DISK_COUNT=0
for img in "${DISK_IMAGES[@]}"; do
    ARGS+=("-drive" "if=none,file=${img},id=blk${DISK_COUNT},format=raw")
    ARGS+=("-device" "virtio-blk-device,drive=blk${DISK_COUNT}")
    ((DISK_COUNT++))
done

if (( DO_NET )); then
    ARGS+=("-netdev" "user,id=vmnic,hostname=qemu")
    ARGS+=("-device" "virtio-net-device,netdev=vmnic")
elif (( DO_NET_TAP )); then
    # quick note to enable tap interface
    # IFNAME=qemu0
    # BRIDGE=bridge0
    # sudo tunctl -u $(whoami) -t ${IFNAME}
    # sudo ifconfig ${IFNAME} up
    # sudo ip link set ${IFNAME} master ${BRIDGE}
    ARGS+=("-netdev" "tap,id=vmnic,ifname=qemu0,script=no,downscript=no")
    ARGS+=("-device" "virtio-net-device,netdev=vmnic")
    #SUDO="sudo"
else
    ARGS+=("-net" "none")
fi

if (( DO_DISPLAY )); then
    ARGS+=("-device" "virtio-gpu-device")
    ARGS+=("-serial" "stdio")
    ARGS+=("-device" "virtio-keyboard-device")
    ARGS+=("-device" "virtio-mouse-device")
else
    ARGS+=("-nographic")
fi

if (( DO_V9P )); then
    ARGS+=("-fsdev" "local,path=$DO_V9P_DIR,security_model=mapped,id=v9p0")
    ARGS+=("-device" "virtio-9p-device,fsdev=v9p0,mount_tag=V9P0")
fi

MAKE_VARS=""

if (( DO_CMPCTMALLOC )); then
    MAKE_VARS="LK_HEAP_IMPLEMENTATION=cmpctmalloc"
elif (( DO_MINIHEAP )); then
    MAKE_VARS="LK_HEAP_IMPLEMENTATION=miniheap"
fi

CMD=()
if [[ -n "$SUDO" ]]; then
    CMD+=("sudo")
fi
CMD+=("$QEMU")
CMD+=("${ARGS[@]}")
CMD+=("$@")

if (( DO_DRYRUN )); then
    echo "${CMD[@]}"
    exit 0
fi

set -e
"$DIR"/make-parallel $MAKE_VARS PROJECT="$PROJECT"
echo "${CMD[@]}"
exec "${CMD[@]}"
